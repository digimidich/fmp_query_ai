<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digimidi Query Builder</title>
  <style>
    :root { --bg:#f6f7f9; --fg:#1f2937; --muted:#6b7280; --accent:#111827; --ok:#065f46; --err:#7f1d1d; --border:#e5e7eb; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width:1100px; margin:40px auto; padding:0 16px; }
    header { margin-bottom:16px; }
    h1 { margin:0 0 8px; font-weight:600; font-size:22px; }
    p.lead { margin:0; color:var(--muted); }
    .bar { display:flex; gap:8px; margin:16px 0 0; }
    input.query, input.filter, input.search { flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:8px; outline:none; font-size:15px; }
    input.query:focus, input.filter:focus, input.search:focus { border-color:#cbd5e1; box-shadow:0 0 0 3px rgba(59,130,246,.15); }
    button.go { padding:10px 14px; border:0; border-radius:8px; background:var(--accent); color:#fff; cursor:pointer; font-weight:600; }
    button.go[disabled] { opacity:.6; cursor:progress; }
    .card { background:#fff; border:1px solid #eef0f3; border-radius:12px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.04); margin-top:16px; }
    .msg { padding:10px 12px; border-radius:8px; margin:8px 0 0; font-size:14px; }
    .msg.ok { background:#ecfdf5; color:var(--ok); border:1px solid #a7f3d0; }
    .msg.err { background:#fef2f2; color:var(--err); border:1px solid #fecaca; white-space:pre-wrap; }
    .muted { color:var(--muted); font-size:14px; }
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid #fff; border-right-color:transparent; border-radius:50%; animation:spin .8s linear infinite; vertical-align:-3px; margin-right:6px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Table */
    .toolbar { display:flex; gap:8px; align-items:center; justify-content:space-between; margin:8px 0 0; flex-wrap:wrap; }
    .count { font-size:14px; color:var(--muted); }
    table { width:100%; border-collapse:separate; border-spacing:0; margin-top:10px; }
    thead th { position:sticky; top:0; background:#f8fafc; z-index:1; border-bottom:1px solid var(--border); text-align:left; padding:10px; font-size:14px; cursor:pointer; }
    thead th.sortable:hover { background:#eef2f7; }
    tbody td { border-bottom:1px solid var(--border); padding:10px; font-size:14px; }
    .filters { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; margin-top:10px; }
    .nowrap { white-space:nowrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ü§ñ Digimidi Query Builder</h1>
      <p class="lead">Le navigateur appelle <code>/api/filemaker</code> (proxy serveur). Les donn√©es sont affich√©es en tableau triable & filtrable.</p>
      <div class="bar">
        <input id="q" class="query" placeholder="Ex. : chiens > 50 kg non st√©rilis√©s" />
        <button id="go" class="go" onclick="processQuery()">Rechercher</button>
      </div>
      <p class="muted">Astuce : Entr√©e pour lancer la recherche.</p>
    </header>

    <section id="panel" class="card">
      <div id="status" class="muted">Pr√™t.</div>
      <div id="messages"></div>

      <div class="toolbar">
        <input id="globalSearch" class="search" placeholder="üîé Recherche globale (nom, race, esp√®ce‚Ä¶)" />
        <div class="count" id="count">0 √©l√©ments</div>
      </div>

      <!-- Filtres par colonne -->
      <div class="filters">
        <input class="filter" data-key="nom" placeholder="Filtrer: nom" />
        <input class="filter" data-key="espece" placeholder="Filtrer: esp√®ce" />
        <input class="filter" data-key="race" placeholder="Filtrer: race" />
        <input class="filter" data-key="poids" placeholder="Filtrer: poids (ex: >50)" />
        <input class="filter" data-key="sterilisee" placeholder="Filtrer: st√©rilis√©e (OUI/NON)" />
        <input class="filter" data-key="date_naissance" placeholder="Filtrer: date naissance" />
        <input class="filter" data-key="id" placeholder="Filtrer: id" />
      </div>

      <div id="tableWrap"></div>
      <div id="out" style="display:none"></div>
    </section>
  </div>

  <script>
    const q = document.getElementById('q');
    const go = document.getElementById('go');
    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const outEl = document.getElementById('out');
    const tableWrap = document.getElementById('tableWrap');
    const countEl = document.getElementById('count');
    const globalSearch = document.getElementById('globalSearch');
    const filterInputs = Array.from(document.querySelectorAll('.filter'));

    let rawRows = [];   // donn√©es brutes parseÃÅes
    let viewRows = [];  // donn√©es filtr√©es/tri√©es
    let sortState = { key: 'nom', dir: 'asc' };

    q.addEventListener('keydown', e => { if (e.key === 'Enter') processQuery(); });
    globalSearch.addEventListener('input', applyFilters);
    filterInputs.forEach(inp => inp.addEventListener('input', applyFilters));

    function setLoading(isLoading) {
      go.disabled = isLoading;
      go.innerHTML = isLoading ? '<span class="spinner"></span>Recherche‚Ä¶' : 'Rechercher';
      statusEl.textContent = isLoading ? 'Requ√™te en cours‚Ä¶' : 'Pr√™t.';
    }
    function showMsg(text, kind='ok') {
      const div = document.createElement('div');
      div.className = `msg ${kind}`;
      div.textContent = text;
      messagesEl.appendChild(div);
    }
    function showError(msg){ showMsg(msg, 'err'); }
    function escapeHtml(str){ return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function normalizeRow(r){
      // Convertit les cleÃÅs FR/espaces vers des cleÃÅs stables pour l'affichage/tri/filtre
      return {
        nom: r.nom ?? '',
        espece: r.espece ?? '',
        race: r.race ?? '',
        poids: (r.poids === '' || r.poids === null || r.poids === undefined) ? null : Number(r.poids),
        sterilisee: (r['sterilis√©e'] ?? r.sterilisee ?? '').toString().trim().toUpperCase(),
        date_naissance: r['date naissance'] ?? r.date_naissance ?? '',
        id: r.id ?? ''
      };
    }

    function parseResultParameter(payload){
      // payload peut √™tre { resultParameter: "<string JSON>" } ou similaire
      if (!payload) return [];
      const rp = payload.resultParameter ?? payload.ResultParameter ?? payload.result ?? payload;
      if (Array.isArray(rp)) return rp.map(normalizeRow);
      if (typeof rp !== 'string') return [];

      // extrait la premi√®re grosse liste JSON [ ... ] du texte
      const start = rp.indexOf('[');
      const end = rp.lastIndexOf(']');
      if (start === -1 || end === -1 || end <= start) return [];
      const jsonSlice = rp.slice(start, end + 1);

      try {
        const arr = JSON.parse(jsonSlice);
        return arr.map(normalizeRow);
      } catch (e) {
        console.error('JSON parse error', e);
        return [];
      }
    }

    function renderTable(rows){
      const headers = [
        { key:'nom', label:'Nom' },
        { key:'espece', label:'Esp√®ce' },
        { key:'race', label:'Race' },
        { key:'poids', label:'Poids (kg)', class:'nowrap' },
        { key:'sterilisee', label:'St√©rilis√©e' },
        { key:'date_naissance', label:'Date naissance', class:'nowrap' },
        { key:'id', label:'ID' },
      ];

      const ths = headers.map(h => {
        const dir = (sortState.key === h.key) ? (sortState.dir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : '';
        const cls = 'sortable' + (h.class ? ' ' + h.class : '');
        return `<th data-key="${h.key}" class="${cls}">${h.label}${dir}</th>`;
      }).join('');

      const trs = rows.map(r => `
        <tr>
          <td>${escapeHtml(r.nom)}</td>
          <td>${escapeHtml(r.espece)}</td>
          <td>${escapeHtml(r.race)}</td>
          <td class="nowrap">${r.poids ?? ''}</td>
          <td>${escapeHtml(r.sterilisee)}</td>
          <td class="nowrap">${escapeHtml(r.date_naissance)}</td>
          <td>${escapeHtml(r.id)}</td>
        </tr>
      `).join('');

      tableWrap.innerHTML = `
        <table>
          <thead><tr>${ths}</tr></thead>
          <tbody>${trs}</tbody>
        </table>
      `;

      // bind tri
      tableWrap.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-key');
          if (sortState.key === key) {
            sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
          } else {
            sortState.key = key;
            sortState.dir = 'asc';
          }
          applySort();
          renderTable(viewRows);
        });
      });

      countEl.textContent = `${rows.length} √©l√©ment${rows.length>1?'s':''}`;
    }

    function applySort(){
      const { key, dir } = sortState;
      const collator = new Intl.Collator('fr', { sensitivity:'base', numeric:true });
      viewRows.sort((a,b) => {
        let av = a[key], bv = b[key];
        if (key === 'poids') {
          av = (av ?? -Infinity);
          bv = (bv ?? -Infinity);
          return dir === 'asc' ? (av - bv) : (bv - av);
        }
        const r = collator.compare(String(av ?? ''), String(bv ?? ''));
        return dir === 'asc' ? r : -r;
      });
    }

    function matchFilter(row, key, val){
      if (!val) return true;
      val = val.trim();
      if (!val) return true;

      // Op√©rateurs simples pour poids: >, >=, <, <=, =
      if (key === 'poids') {
        const m = val.match(/^(>=|<=|>|<|=)\s*([\d.,]+)$/);
        if (m) {
          const op = m[1]; const num = Number(m[2].replace(',','.'));
          const v = Number(row.poids ?? NaN);
          if (Number.isNaN(v)) return false;
          switch(op){
            case '>':  return v >  num;
            case '>=': return v >= num;
            case '<':  return v <  num;
            case '<=': return v <= num;
            case '=':  return v === num;
          }
        }
      }

      // par d√©faut: contient (case-insensitive)
      const hay = String(row[key] ?? '').toLowerCase();
      return hay.includes(val.toLowerCase());
    }

    function applyFilters(){
      const qGlob = globalSearch.value.trim().toLowerCase();
      const perCol = Object.fromEntries(filterInputs.map(i => [i.dataset.key, i.value || '']));

      viewRows = rawRows.filter(r => {
        // global
        if (qGlob) {
          const s = `${r.nom} ${r.espece} ${r.race} ${r.sterilisee} ${r.date_naissance} ${r.id}`.toLowerCase();
          if (!s.includes(qGlob)) return false;
        }
        // per-column
        for (const [k,v] of Object.entries(perCol)) {
          if (!matchFilter(r, k, v)) return false;
        }
        return true;
      });

      applySort();
      renderTable(viewRows);
    }

    async function processQuery() {
      const query = q.value.trim();
      messagesEl.innerHTML = '';
      outEl.innerHTML = '';
      tableWrap.innerHTML = '';
      if (!query) return showError('Merci de saisir une requ√™te.');

      try {
        setLoading(true);

        const resp = await fetch('/api/filemaker', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scriptParameterValue: query })
        });

        const contentType = resp.headers.get('content-type') || '';
        let data = contentType.includes('application/json') ? await resp.json() : { raw: await resp.text() };
        if (!resp.ok) { showError(`Erreur ${resp.status} : ${JSON.stringify(data, null, 2)}`); return; }

        // Parse les lignes depuis resultParameter
        rawRows = parseResultParameter(data).map(r => r);
        viewRows = [...rawRows];
        showMsg('R√©ponse re√ßue ‚úîÔ∏é');

        applySort();
        renderTable(viewRows);
      } catch (err) {
        showError(`Erreur r√©seau : ${err.message}`);
      } finally {
        setLoading(false);
      }
    }
  </script>
</body>
</html>