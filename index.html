<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digimidi Query Builder</title>
  <style>
    :root { --bg:#f6f7f9; --fg:#1f2937; --muted:#6b7280; --accent:#111827; --ok:#065f46; --err:#7f1d1d; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width:1000px; margin:40px auto; padding:0 16px; }
    header { margin-bottom:16px; }
    h1 { margin:0 0 8px; font-weight:600; font-size:22px; }
    p.lead { margin:0; color:var(--muted); }
    .bar { display:flex; gap:8px; margin:16px 0 0; }
    input.query { flex:1; padding:12px 14px; border:1px solid #e5e7eb; border-radius:8px; outline:none; font-size:16px; }
    input.query:focus { border-color:#cbd5e1; box-shadow:0 0 0 3px rgba(59,130,246,.15); }
    button.go { padding:12px 16px; border:0; border-radius:8px; background:var(--accent); color:#fff; cursor:pointer; font-weight:600; }
    button.go[disabled] { opacity:.6; cursor:progress; }
    .card { background:#fff; border:1px solid #eef0f3; border-radius:12px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.04); margin-top:16px; }
    .msg { padding:10px 12px; border-radius:8px; margin:8px 0 0; font-size:14px; }
    .msg.ok { background:#ecfdf5; color:var(--ok); border:1px solid #a7f3d0; }
    .msg.err { background:#fef2f2; color:var(--err); border:1px solid #fecaca; white-space:pre-wrap; }
    pre { margin:12px 0 0; background:#0b1020; color:#e5e7eb; padding:12px; border-radius:8px; overflow:auto; font-size:13px; }
    .muted { color:var(--muted); font-size:14px; }
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid #fff; border-right-color:transparent; border-radius:50%; animation:spin .8s linear infinite; vertical-align:-3px; margin-right:6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸ¤– Digimidi Query Builder</h1>
      <p class="lead">Saisis une requÃªte (FR/EN). Le navigateur appelle <code>/api/filemaker</code> cÃ´tÃ© serveur â€” aucune clÃ©/autorisation cÃ´tÃ© client.</p>
      <div class="bar">
        <input id="q" class="query" placeholder="Ex. : chiens stÃ©rilisÃ©s depuis 2022 Ã  Lutry" />
        <button id="go" class="go" onclick="processQuery()">
          Rechercher
        </button>
      </div>
      <p class="muted">Astuce : EntrÃ©e pour lancer la recherche.</p>
    </header>

    <section id="panel" class="card">
      <div id="status" class="muted">PrÃªt.</div>
      <div id="messages"></div>
      <div id="out"></div>
    </section>
  </div>

  <script>
    const q = document.getElementById('q');
    const go = document.getElementById('go');
    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const outEl = document.getElementById('out');

    q.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') processQuery();
    });

    function setLoading(isLoading) {
      go.disabled = isLoading;
      go.innerHTML = isLoading ? '<span class="spinner"></span>Rechercheâ€¦' : 'Rechercher';
      statusEl.textContent = isLoading ? 'RequÃªte en coursâ€¦' : 'PrÃªt.';
    }

    function showMsg(text, kind = 'ok') {
      const div = document.createElement('div');
      div.className = `msg ${kind}`;
      div.textContent = text;
      messagesEl.appendChild(div);
    }

    function showError(errText) {
      showMsg(errText, 'err');
    }

    function showJSON(obj) {
      outEl.innerHTML = '<pre>' + escapeHtml(JSON.stringify(obj, null, 2)) + '</pre>';
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    async function processQuery() {
      const query = q.value.trim();
      messagesEl.innerHTML = '';
      outEl.innerHTML = '';
      if (!query) {
        showError('Merci de saisir une requÃªte.');
        return;
      }
      try {
        setLoading(true);

        // ðŸ‘‰ Appel unique au backend Koyeb (proxy cÃ´tÃ© serveur)
        // Important : aucune clÃ©/API ni autorisation dans le front.
        // Le serveur lit OPENAI_API_KEY / FM_AUTH_B64 via variables dâ€™environnement.
        const resp = await fetch('/api/filemaker', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          // Garde le nom "scriptParameterValue" si ton backend le forwarde tel quel Ã  FileMaker
          body: JSON.stringify({ scriptParameterValue: query })
        });

        const contentType = resp.headers.get('content-type') || '';
        let data;
        if (contentType.includes('application/json')) {
          data = await resp.json();
        } else {
          const text = await resp.text();
          data = { raw: text };
        }

        if (!resp.ok) {
          showError(`Erreur ${resp.status} : ${JSON.stringify(data, null, 2)}`);
          return;
        }

        showMsg('RÃ©ponse reÃ§ue âœ”ï¸Ž', 'ok');
        showJSON(data);
      } catch (err) {
        showError(`Erreur rÃ©seau : ${err.message}`);
      } finally {
        setLoading(false);
      }
    }
  </script>
</body>
</html>