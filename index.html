<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digimidi Query Builder</title>
  <style>
    :root { --bg:#f6f7f9; --fg:#1f2937; --muted:#6b7280; --accent:#0f172a; --ok:#065f46; --err:#7f1d1d; --border:#e5e7eb; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width:1100px; margin:40px auto; padding:0 16px; }
    header { margin-bottom:16px; }
    h1 { margin:0 0 8px; font-weight:700; font-size:22px; }
    p.lead { margin:0; color:var(--muted); }
    .bar { display:flex; gap:8px; margin:16px 0 0; }
    input.query, input.filter, input.search {
      flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none; font-size:15px; background:#fff;
    }
    input.query:focus, input.filter:focus, input.search:focus {
      border-color:#cbd5e1; box-shadow:0 0 0 3px rgba(59,130,246,.15);
    }
    button.go { padding:10px 14px; border:0; border-radius:10px; background:var(--accent); color:#fff; cursor:pointer; font-weight:700; }
    button.go[disabled] { opacity:.6; cursor:progress; }
    .card { background:#fff; border:1px solid #eef0f3; border-radius:16px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.04); margin-top:16px; }
    .msg { padding:10px 12px; border-radius:10px; margin:8px 0 0; font-size:14px; }
    .msg.ok { background:#ecfdf5; color:var(--ok); border:1px solid #a7f3d0; }
    .msg.err { background:#fef2f2; color:var(--err); border:1px solid #fecaca; white-space:pre-wrap; }
    .muted { color:var(--muted); font-size:14px; }
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid #fff; border-right-color:transparent; border-radius:50%; animation:spin .8s linear infinite; vertical-align:-3px; margin-right:6px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .toolbar { display:flex; gap:8px; align-items:center; justify-content:space-between; margin:8px 0 0; flex-wrap:wrap; }
    .count { font-size:14px; color:var(--muted); }

    .table-scroll { width:100%; overflow:auto; border:1px solid var(--border); border-radius:12px; }
    table { min-width: 800px; width:100%; border-collapse:separate; border-spacing:0; }
    thead th {
      position:sticky; top:0; background:#f8fafc; z-index:1;
      border-bottom:1px solid var(--border); text-align:left; padding:10px; font-size:14px; cursor:pointer; white-space:nowrap;
    }
    thead th.sortable:hover { background:#eef2f7; }
    tbody td { border-bottom:1px solid var(--border); padding:10px; font-size:14px; }
    .filters { display:grid; grid-template-columns: repeat(7, minmax(130px,1fr)); gap:6px; margin:10px 0; }
    .nowrap { white-space:nowrap; }

    /* Responsive : masque quelques colonnes en petit √©cran */
    @media (max-width: 900px) {
      .filters { grid-template-columns: repeat(4, 1fr); }
      th.col-id, td.col-id { display:none; }
    }
    @media (max-width: 720px) {
      .bar { flex-direction:column; }
      .filters { grid-template-columns: repeat(2, 1fr); }
      th.col-date, td.col-date { display:none; }
      th.col-espece, td.col-espece { display:none; }
      table { min-width: 0; } /* autorise le wrap + scroll */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ü§ñ Digimidi Query Builder</h1>
      <p class="lead">Le navigateur appelle <code>/api/filemaker</code> (proxy serveur). Donn√©es affich√©es en tableau triable & filtrable.</p>
      <div class="bar">
        <input id="q" class="query" placeholder="Ex. : dogs > 50 kg not sterilized" />
        <button id="go" class="go" onclick="processQuery()">Rechercher</button>
      </div>
      <p class="muted">Astuce : Entr√©e pour lancer la recherche.</p>
    </header>

    <section class="card">
      <div id="status" class="muted">Pr√™t.</div>
      <div id="messages"></div>
      <div id="debug" class="muted" style="white-space:pre-wrap; margin-top:8px;"></div>

      <div class="toolbar">
        <input id="globalSearch" class="search" placeholder="üîé Recherche globale (nom, race, esp√®ce‚Ä¶)" />
        <div class="count" id="count">0 √©l√©ment</div>
      </div>

      <div class="filters">
        <input class="filter" data-key="nom" placeholder="Filtrer: nom" />
        <input class="filter" data-key="espece" placeholder="Filtrer: esp√®ce" />
        <input class="filter" data-key="race" placeholder="Filtrer: race" />
        <input class="filter" data-key="poids" placeholder="Filtrer: poids (ex: >50)" />
        <input class="filter" data-key="sterilisee" placeholder="Filtrer: st√©rilis√©e (OUI/NON)" />
        <input class="filter" data-key="date_naissance" placeholder="Filtrer: date naissance" />
        <input class="filter" data-key="id" placeholder="Filtrer: id" />
      </div>

      <div id="tableWrap" class="table-scroll"></div>
    </section>
  </div>

  <script>
    const q = document.getElementById('q');
    const go = document.getElementById('go');
    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const tableWrap = document.getElementById('tableWrap');
    const countEl = document.getElementById('count');
    const globalSearch = document.getElementById('globalSearch');
    const filterInputs = Array.from(document.querySelectorAll('.filter'));
    const debugEl = document.getElementById('debug');

    let rawRows = [];
    let viewRows = [];
    let sortState = { key: 'poids', dir: 'asc' };

    q.addEventListener('keydown', e => { if (e.key === 'Enter') processQuery(); });
    globalSearch.addEventListener('input', applyFilters);
    filterInputs.forEach(inp => inp.addEventListener('input', applyFilters));

    function setLoading(isLoading) {
      go.disabled = isLoading;
      go.innerHTML = isLoading ? '<span class="spinner"></span>Recherche‚Ä¶' : 'Rechercher';
      statusEl.textContent = isLoading ? 'Requ√™te en cours‚Ä¶' : 'Pr√™t.';
    }
    function showMsg(text, kind='ok') {
      const div = document.createElement('div');
      div.className = `msg ${kind}`;
      div.textContent = text;
      messagesEl.innerHTML = '';
      messagesEl.appendChild(div);
    }
    function showError(msg){ showMsg(msg, 'err'); }
    function escapeHtml(str){ return (str??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // r√©cup√®re un array JSON o√π qu‚Äôil se cache (objet, string, texte brut)
    function extractArrayFromAny(any) {
      if (!any) return [];
      if (Array.isArray(any)) return any;

      // Cas objet : on teste d'abord les sch√©mas connus puis on explore r√©cursivement toutes les cl√©s
      if (typeof any === 'object') {
        // 1) OData : { value: [ { resultParameter: "..." } ] }
        if (Array.isArray(any.value) && any.value.length) {
          const v0 = any.value[0];
          const fromValue = (v0 && (v0.resultParameter ?? v0.ResultParameter ?? v0)) ?? null;
          const arrFromValue = extractArrayFromAny(fromValue);
          if (arrFromValue.length) return arrFromValue;
        }

        // 2) FileMaker ScriptResult : { scriptResult: { resultParameter: "..." } }
        if (any.scriptResult) {
          const cand = any.scriptResult.resultParameter ?? any.scriptResult.ResultParameter ?? null;
          if (cand) {
            const got = extractArrayFromAny(cand);
            if (got.length) return got;
          }
        }

        // 3) Cas g√©n√©ral : resultParameter √† la racine
        const directCand = any.resultParameter ?? any.ResultParameter ?? any.result ?? any.data ?? any.raw ?? null;
        if (directCand) {
          const got = extractArrayFromAny(directCand);
          if (got.length) return got;
        }

        // 4) Exploration r√©cursive de toutes les valeurs de l'objet (pour attraper des cl√©s inattendues)
        for (const v of Object.values(any)) {
          const got = extractArrayFromAny(v);
          if (got.length) return got;
        }
        return [];
      }

      // Cas string
      if (typeof any === 'string') {
        // si la string elle-m√™me est un JSON valide
        try {
          const parsed = JSON.parse(any);
          return extractArrayFromAny(parsed);
        } catch (_) {}

        // sinon, on isole le premier [ ... ] √©quilibr√©
        const start = any.indexOf('[');
        const end = any.lastIndexOf(']');
        if (start !== -1 && end !== -1 && end > start) {
          const slice = any.slice(start, end + 1);
          try { return JSON.parse(slice); } catch(_) {}
        }
      }
      return [];
    }

    // Affiche un aper√ßu brut de la r√©ponse et le premier id d√©tect√©
    function showDebugRaw(rawText, payload) {
      const head = rawText.slice(0, 600);
      let firstId = '(aucun)';
      try {
        const arr = extractArrayFromAny(payload);
        if (Array.isArray(arr) && arr.length) {
          const first = arr[0];
          firstId = (first && (first.id ?? first.ID ?? first.Id)) ?? '(pas de cl√© id)';
        }
      } catch (_) {}
      debugEl.textContent =
`[DEBUG] Aper√ßu r√©ponse brute (600 chars):
${head}

[DEBUG] typeof payload: ${typeof payload}
[DEBUG] cl√©s payload: ${payload && typeof payload === 'object' ? Object.keys(payload).join(', ') : '(n/a)'}
[DEBUG] Premier id d√©tect√©: ${firstId}`;
    }

    function normalizeRow(r){
      const steriliseeRaw = r['sterilis√©e'] ?? r['st√©rilis√©e'] ?? r.sterilisee ?? r.sterilisee ?? r.sterilized ?? '';
      const dateN = r['date naissance'] ?? r.date_naissance ?? r.dateNaissance ?? r.birth_date ?? '';
      return {
        nom: r.nom ?? r.name ?? '',
        espece: r.espece ?? r.espeÃÄce ?? r.species ?? '',
        race: r.race ?? r.breed ?? '',
        poids: (r.poids === '' || r.poids == null) ? null : Number(r.poids),
        sterilisee: String(steriliseeRaw ?? '').trim().toUpperCase(),
        date_naissance: dateN,
        id: r.id ?? r.ID ?? r.Id ?? ''
      };
    }

    function renderTable(rows){
      const headers = [
        { key:'nom', label:'Nom' },
        { key:'espece', label:'Esp√®ce', class:'col-espece' },
        { key:'race', label:'Race' },
        { key:'poids', label:'Poids (kg)', class:'nowrap' },
        { key:'sterilisee', label:'St√©rilis√©e' },
        { key:'date_naissance', label:'Date naissance', class:'nowrap col-date' },
        { key:'id', label:'ID', class:'col-id' },
      ];

      const ths = headers.map(h => {
        const dir = (sortState.key === h.key) ? (sortState.dir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : '';
        const cls = 'sortable' + (h.class ? ' ' + h.class : '');
        return `<th data-key="${h.key}" class="${cls}">${h.label}${dir}</th>`;
      }).join('');

      let trs = rows.map(r => `
        <tr>
          <td>${escapeHtml(r.nom)}</td>
          <td class="col-espece">${escapeHtml(r.espece)}</td>
          <td>${escapeHtml(r.race)}</td>
          <td class="nowrap">${r.poids ?? ''}</td>
          <td>${escapeHtml(r.sterilisee)}</td>
          <td class="nowrap col-date">${escapeHtml(r.date_naissance)}</td>
          <td class="col-id">${escapeHtml(r.id)}</td>
        </tr>
      `).join('');
      if (!trs) {
        trs = `<tr><td colspan="7" class="muted" style="text-align:center;padding:16px;">Aucune donn√©e</td></tr>`;
      }

      tableWrap.innerHTML = `
        <table>
          <thead><tr>${ths}</tr></thead>
          <tbody>${trs}</tbody>
        </table>
      `;

      // tri
      tableWrap.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-key');
          if (sortState.key === key) {
            sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
          } else {
            sortState.key = key; sortState.dir = 'asc';
          }
          applySort(); renderTable(viewRows);
        });
      });

      countEl.textContent = `${rows.length} √©l√©ment${rows.length>1?'s':''}`;
    }

    function applySort(){
      const { key, dir } = sortState;
      const collator = new Intl.Collator('fr', { sensitivity:'base', numeric:true });
      viewRows.sort((a,b) => {
        if (key === 'poids') {
          const av = a.poids ?? -Infinity;
          const bv = b.poids ?? -Infinity;
          return dir === 'asc' ? (av - bv) : (bv - av);
        }
        const r = collator.compare(String(a[key] ?? ''), String(b[key] ?? ''));
        return dir === 'asc' ? r : -r;
      });
    }

    function matchFilter(row, key, val){
      if (!val) return true;
      val = val.trim(); if (!val) return true;

      if (key === 'poids') {
        const m = val.match(/^(>=|<=|>|<|=)\s*([\d.,]+)$/);
        if (m) {
          const op = m[1], num = Number(m[2].replace(',','.'));
          const v = Number(row.poids ?? NaN);
          if (Number.isNaN(v)) return false;
          return op === '>' ? v > num :
                 op === '>=' ? v >= num :
                 op === '<' ? v < num :
                 op === '<=' ? v <= num :
                 v === num;
        }
      }

      const hay = String(row[key] ?? '').toLowerCase();
      return hay.includes(val.toLowerCase());
    }

    function applyFilters(){
      const qGlob = globalSearch.value.trim().toLowerCase();
      const perCol = Object.fromEntries(filterInputs.map(i => [i.dataset.key, i.value || '']));

      viewRows = rawRows.filter(r => {
        if (qGlob) {
          const s = `${r.nom} ${r.espece} ${r.race} ${r.sterilisee} ${r.date_naissance} ${r.id}`.toLowerCase();
          if (!s.includes(qGlob)) return false;
        }
        for (const [k,v] of Object.entries(perCol)) {
          if (!matchFilter(r, k, v)) return false;
        }
        return true;
      });

      applySort();
      renderTable(viewRows);
    }

    // parse sp√©cifiquement scriptResult.resultParameter (souvent une string JSON avec \r etc.)
    function parseResultParam(str) {
      if (str == null) return [];
      if (Array.isArray(str)) return str;
      if (typeof str !== 'string') return extractArrayFromAny(str);
      // 1) tentative JSON.parse directe
      try { 
        const v = JSON.parse(str);
        return Array.isArray(v) ? v : extractArrayFromAny(v);
      } catch(_) {}
      // 2) isole la premi√®re s√©quence [ ... ] et parse
      const start = str.indexOf('[');
      const end = str.lastIndexOf(']');
      if (start !== -1 && end !== -1 && end > start) {
        const slice = str.slice(start, end + 1);
        try {
          const v = JSON.parse(slice);
          return Array.isArray(v) ? v : extractArrayFromAny(v);
        } catch(_) {}
      }
      return [];
    }

    async function processQuery() {
      const query = q.value.trim();
      messagesEl.innerHTML = '';
      tableWrap.innerHTML = '';
      debugEl.textContent = '';
      if (!query) return showError('Merci de saisir une requ√™te.');

      try {
        setLoading(true);

        // On lit TOUJOURS en texte puis on essaie de parser JSON (robuste aux content-types exotiques)
        const resp = await fetch('/api/filemaker', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scriptParameterValue: query })
        });
        const rawText = await resp.text();

        let payload;
        try { payload = JSON.parse(rawText); } catch { payload = { raw: rawText }; }

        // Affiche un aper√ßu de la r√©ponse brute et tente d'extraire un id
        showDebugRaw(rawText, payload);

        // Fast-path pour FileMaker: parse directement scriptResult.resultParameter si pr√©sent
        let fastRows = [];
        if (payload && payload.scriptResult && (payload.scriptResult.resultParameter || payload.scriptResult.ResultParameter)) {
          const rp = payload.scriptResult.resultParameter ?? payload.scriptResult.ResultParameter;
          fastRows = parseResultParam(rp);
        }

        if (!resp.ok) {
          showError(`Erreur ${resp.status} : ${rawText.slice(0, 300)}‚Ä¶`);
          return;
        }

        // -> extraction robuste (pr√©f√®re le fast-path)
        let arr = [];
        if (Array.isArray(fastRows) && fastRows.length) {
          arr = fastRows;
        } else {
          arr = extractArrayFromAny(payload);
        }
        rawRows = Array.isArray(arr) ? arr.map(normalizeRow) : [];
        viewRows = [...rawRows];

        if (!viewRows.length) {
          showMsg('R√©ponse re√ßue mais aucune ligne pars√©e. V√©rifie le sch√©ma (resultParameter / OData value).', 'err');
          applySort();
          renderTable(viewRows); // affiche quand m√™me l‚Äôen-t√™te et la ligne ‚ÄúAucune donn√©e‚Äù
          return;
        }

        showMsg(`R√©ponse re√ßue ‚úîÔ∏é (${viewRows.length} lignes)`, 'ok');
        applySort();
        renderTable(viewRows);
      } catch (err) {
        showError(`Erreur r√©seau : ${err.message}`);
      } finally {
        setLoading(false);
      }
    }
  </script>
</body>
</html>