<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digimidi Query Builder</title>
  <style>
    :root { --bg:#f6f7f9; --fg:#1f2937; --muted:#6b7280; --accent:#0f172a; --ok:#065f46; --err:#7f1d1d; --border:#e5e7eb; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width:1100px; margin:40px auto; padding:0 16px; }
    header { margin-bottom:16px; position:relative; }
    .settings-btn {
      position:absolute; top:0; right:0;
      border:1px solid var(--border); background:#fff; border-radius:10px;
      padding:8px 10px; cursor:pointer; font-size:14px;
      box-shadow:0 2px 6px rgba(0,0,0,.05);
    }
    .settings-menu {
      position:absolute; top:42px; right:0; background:#fff; border:1px solid var(--border);
      border-radius:12px; padding:12px; min-width:220px; box-shadow:0 8px 24px rgba(0,0,0,.08); display:none;
      z-index:10;
    }
    .settings-menu label { display:flex; gap:8px; align-items:center; font-size:14px; color:var(--fg); }
    .settings-menu .muted { margin-top:6px; }
    h1 { margin:0 0 8px; font-weight:700; font-size:22px; }
    p.lead { margin:0; color:var(--muted); }
    .bar { display:flex; gap:8px; margin:16px 0 0; }
    input.query, input.search {
      flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none; font-size:15px; background:#fff;
    }
    input.query:focus, input.search:focus {
      border-color:#cbd5e1; box-shadow:0 0 0 3px rgba(59,130,246,.15);
    }
    button.go { padding:10px 14px; border:0; border-radius:10px; background:var(--accent); color:#fff; cursor:pointer; font-weight:700; }
    button.go[disabled] { opacity:.6; cursor:progress; }
    .card { background:#fff; border:1px solid #eef0f3; border-radius:16px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.04); margin-top:16px; }
    .msg { padding:10px 12px; border-radius:10px; margin:8px 0 0; font-size:14px; }
    .msg.ok { background:#ecfdf5; color:var(--ok); border:1px solid #a7f3d0; }
    .msg.err { background:#fef2f2; color:var(--err); border:1px solid #fecaca; white-space:pre-wrap; }
    .muted { color:var(--muted); font-size:14px; }
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid #fff; border-right-color:transparent; border-radius:50%; animation:spin .8s linear infinite; vertical-align:-3px; margin-right:6px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .toolbar { display:flex; gap:8px; align-items:center; justify-content:space-between; margin:8px 0 0; flex-wrap:wrap; }
    .count { font-size:14px; color:var(--muted); }

    .pager { display:flex; align-items:center; gap:8px; }
    .pager button { padding:6px 10px; border:1px solid var(--border); background:#fff; border-radius:8px; cursor:pointer; }
    .pager button:disabled { opacity:.5; cursor:not-allowed; }
    .pager select { padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:#fff; }
    .page-info { font-size:14px; color:var(--muted); }

    .table-scroll { width:100%; overflow:auto; border:1px solid var(--border); border-radius:12px; }
    table { min-width: 800px; width:100%; border-collapse:separate; border-spacing:0; }
    thead th {
      position:sticky; top:0; background:#f8fafc; z-index:1;
      border-bottom:1px solid var(--border); text-align:left; padding:10px; font-size:14px; cursor:pointer; white-space:nowrap;
    }
    thead th.sortable:hover { background:#eef2f7; }
    tbody td { border-bottom:1px solid var(--border); padding:10px; font-size:14px; }
    .nowrap { white-space:nowrap; }

    /* Responsive: hide some columns on small screens */
    @media (max-width: 720px) {
      .bar { flex-direction:column; }
      th.col-date, td.col-date { display:none; }
      th.col-espece, td.col-espece { display:none; }
      table { min-width: 0; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ü§ñ Digimidi Query Builder</h1>
      <p class="lead">Le navigateur appelle <code>/api/filemaker</code> (proxy serveur). Donn√©es affich√©es en tableau triable & filtrable.</p>
      <button id="settingsBtn" class="settings-btn" title="Param√®tres">‚öôÔ∏è</button>
      <div id="settingsMenu" class="settings-menu">
        <label><input type="checkbox" id="toggleRaw"> Afficher la r√©ponse brute</label>
        <div class="muted">Masqu√© par d√©faut. Utile pour le debug.</div>
      </div>
      <div class="bar">
        <input id="q" class="query" placeholder="Ex. : dogs > 50 kg not sterilized" />
        <button id="go" class="go" onclick="processQuery()">Rechercher</button>
      </div>
      <p class="muted">Astuce : Entr√©e pour lancer la recherche.</p>
    </header>

    <section class="card">
      <div id="status" class="muted">Pr√™t.</div>
      <div id="messages"></div>
      <div id="debug" class="muted" style="white-space:pre-wrap; margin-top:8px; display:none;"></div>

      <div class="toolbar">
        <input id="globalSearch" class="search" placeholder="üîé Recherche globale (nom, race, esp√®ce‚Ä¶)" />
        <div class="pager">
          <label class="muted" for="pageSize" style="margin-right:4px;">Par page:</label>
          <select id="pageSize">
            <option value="10" selected>10</option>
            <option value="20">20</option>
          </select>
          <button id="prevPage">‚óÄÔ∏é</button>
          <button id="nextPage">‚ñ∂Ô∏é</button>
          <span id="pageInfo" class="page-info">‚Äî</span>
        </div>
        <div class="count" id="count">0 √©l√©ment</div>
      </div>

      <div id="tableWrap" class="table-scroll"></div>
    </section>
  </div>

  <script>
    const q = document.getElementById('q');
    const go = document.getElementById('go');
    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const tableWrap = document.getElementById('tableWrap');
    const countEl = document.getElementById('count');
    const globalSearch = document.getElementById('globalSearch');
    const debugEl = document.getElementById('debug');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsMenu = document.getElementById('settingsMenu');
    const toggleRaw = document.getElementById('toggleRaw');
    const pageSizeSel = document.getElementById('pageSize');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfoEl = document.getElementById('pageInfo');

    let rawRows = [];
    let viewRows = [];
    let sortState = { key: 'poids', dir: 'asc' };
    /* Pagination */
    let pageSize = 10;
    let currentPage = 1;

    // ---- Settings (show/hide raw debug) ----
    function setDebugVisible(v){
      localStorage.setItem('showRaw', v ? '1' : '0');
      toggleRaw.checked = !!v;
      debugEl.style.display = v ? 'block' : 'none';
    }
    setDebugVisible(localStorage.getItem('showRaw') === '1');

    settingsBtn.addEventListener('click', () => {
      settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
      if (!settingsMenu.contains(e.target) && e.target !== settingsBtn) {
        settingsMenu.style.display = 'none';
      }
    });
    toggleRaw.addEventListener('change', (e) => setDebugVisible(e.target.checked));

    q.addEventListener('keydown', e => { if (e.key === 'Enter') processQuery(); });
    globalSearch.addEventListener('input', applyFilters);

    pageSizeSel.addEventListener('change', () => {
      pageSize = parseInt(pageSizeSel.value, 10) || 10;
      currentPage = 1;
      renderTable(viewRows);
    });
    prevPageBtn.addEventListener('click', () => {
      if (currentPage > 1) { currentPage -= 1; renderTable(viewRows); }
    });
    nextPageBtn.addEventListener('click', () => {
      const totalPages = getTotalPages(viewRows.length);
      if (currentPage < totalPages) { currentPage += 1; renderTable(viewRows); }
    });

    function setLoading(isLoading) {
      go.disabled = isLoading;
      go.innerHTML = isLoading ? '<span class="spinner"></span>Recherche‚Ä¶' : 'Rechercher';
      statusEl.textContent = isLoading ? 'Requ√™te en cours‚Ä¶' : 'Pr√™t.';
    }
    function showMsg(text, kind='ok') {
      const div = document.createElement('div');
      div.className = `msg ${kind}`;
      div.textContent = text;
      messagesEl.innerHTML = '';
      messagesEl.appendChild(div);
    }
    function showError(msg){ showMsg(msg, 'err'); }
    function escapeHtml(str){ return (str??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Parse European dates like dd.MM.yyyy or dd/MM/yyyy, also accept ISO yyyy-MM-dd
    function parseEuDate(input) {
      if (!input) return null;
      const s = String(input).trim();
      if (!s) return null;

      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
        const [Y,M,D] = s.split('-').map(n=>parseInt(n,10));
        const dt = new Date(Date.UTC(Y, M-1, D));
        return isNaN(dt.getTime()) ? null : dt;
      }
      const m = s.match(/^(\d{1,2})[./](\d{1,2})[./](\d{4})$/);
      if (m) {
        const D = parseInt(m[1],10);
        const M = parseInt(m[2],10);
        const Y = parseInt(m[3],10);
        if (Y>=1900 && M>=1 && M<=12 && D>=1 && D<=31) {
          const dt = new Date(Date.UTC(Y, M-1, D));
          return isNaN(dt.getTime()) ? null : dt;
        }
      }
      return null;
    }

    // Compute age as {years, months, label, totalMonths}
    function ageFromDate(birthDate) {
      if (!birthDate) return { years: null, months: null, totalMonths: null, label: '' };
      const now = new Date();
      let y = now.getUTCFullYear() - birthDate.getUTCFullYear();
      let m = now.getUTCMonth() - birthDate.getUTCMonth();
      const d = now.getUTCDate() - birthDate.getUTCDate();
      if (d < 0) m -= 1;
      if (m < 0) { y -= 1; m += 12; }
      const total = y*12 + m;
      const label = `${y} an${y>1?'s':''} ${m} mois`;
      return { years: y, months: m, totalMonths: total, label };
    }

    // Robust extraction of an array payload wherever it hides
    function extractArrayFromAny(any) {
      if (!any) return [];
      if (Array.isArray(any)) return any;

      if (typeof any === 'object') {
        if (Array.isArray(any.value) && any.value.length) {
          const v0 = any.value[0];
          const fromValue = (v0 && (v0.resultParameter ?? v0.ResultParameter ?? v0)) ?? null;
          const arrFromValue = extractArrayFromAny(fromValue);
          if (arrFromValue.length) return arrFromValue;
        }
        if (any.scriptResult) {
          const cand = any.scriptResult.resultParameter ?? any.scriptResult.ResultParameter ?? null;
          if (cand) {
            const got = extractArrayFromAny(cand);
            if (got.length) return got;
          }
        }
        const directCand = any.resultParameter ?? any.ResultParameter ?? any.result ?? any.data ?? any.raw ?? null;
        if (directCand) {
          const got = extractArrayFromAny(directCand);
          if (got.length) return got;
        }
        for (const v of Object.values(any)) {
          const got = extractArrayFromAny(v);
          if (got.length) return got;
        }
        return [];
      }

      if (typeof any === 'string') {
        try {
          const parsed = JSON.parse(any);
          return extractArrayFromAny(parsed);
        } catch (_) {}
        const start = any.indexOf('[');
        const end = any.lastIndexOf(']');
        if (start !== -1 && end !== -1 && end > start) {
          const slice = any.slice(start, end + 1);
          try { return JSON.parse(slice); } catch(_) {}
        }
      }
      return [];
    }

    // Show a small raw preview and first id (hidden unless toggled)
    function showDebugRaw(rawText, payload) {
      const head = rawText.slice(0, 600);
      let firstId = '(aucun)';
      try {
        const arr = extractArrayFromAny(payload);
        if (Array.isArray(arr) && arr.length) {
          const first = arr[0];
          firstId = (first && (first.id ?? first.ID ?? first.Id)) ?? '(pas de cl√© id)';
        }
      } catch (_) {}
      debugEl.textContent =
`[DEBUG] Aper√ßu r√©ponse brute (600 chars):
${head}

[DEBUG] typeof payload: ${typeof payload}
[DEBUG] cl√©s payload: ${payload && typeof payload === 'object' ? Object.keys(payload).join(', ') : '(n/a)'}
[DEBUG] Premier id d√©tect√©: ${firstId}`;
    }

    function normalizeRow(r){
      const steriliseeRaw = r['sterilis√©e'] ?? r['st√©rilis√©e'] ?? r.sterilisee ?? r.sterilized ?? '';
      const dateN = r['date naissance'] ?? r.date_naissance ?? r.dateNaissance ?? r.birth_date ?? '';
      const birthParsed = parseEuDate(dateN);
      const age = ageFromDate(birthParsed);
      return {
        nom: r.nom ?? r.name ?? '',
        espece: r.espece ?? r.espeÃÄce ?? r.species ?? '',
        race: r.race ?? r.breed ?? '',
        poids: (r.poids === '' || r.poids == null) ? null : Number(r.poids),
        sterilisee: String(steriliseeRaw ?? '').trim().toUpperCase(),
        date_naissance: dateN,
        age_label: age.label,
        age_months: age.totalMonths,
        id: r.id ?? r.ID ?? r.Id ?? ''
      };
    }

    function getTotalPages(total){ return Math.max(1, Math.ceil(total / pageSize)); }
    function updatePager(total){
      const totalPages = getTotalPages(total);
      const start = total === 0 ? 0 : (currentPage - 1) * pageSize + 1;
      const end = Math.min(currentPage * pageSize, total);
      pageInfoEl.textContent = `${start}‚Äì${end} / ${total}`;
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
    }

    function renderTable(rows){
      const headers = [
        { key:'nom', label:'Nom' },
        { key:'espece', label:'Esp√®ce', class:'col-espece' },
        { key:'race', label:'Race' },
        { key:'poids', label:'Poids (kg)', class:'nowrap' },
        { key:'age', label:'√Çge' },
        { key:'sterilisee', label:'St√©rilis√©e' },
        { key:'date_naissance', label:'Date naissance', class:'nowrap col-date' },
      ];

      const total = rows.length;
      const totalPages = getTotalPages(total);
      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      const startIdx = (currentPage - 1) * pageSize;
      const endIdx = Math.min(startIdx + pageSize, total);
      const pageRows = rows.slice(startIdx, endIdx);

      const ths = headers.map(h => {
        const dir = (sortState.key === h.key) ? (sortState.dir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : '';
        const cls = 'sortable' + (h.class ? ' ' + h.class : '');
        return `<th data-key="${h.key}" class="${cls}">${h.label}${dir}</th>`;
      }).join('');

      let trs = pageRows.map(r => `
        <tr>
          <td>${escapeHtml(r.nom)}</td>
          <td class="col-espece">${escapeHtml(r.espece)}</td>
          <td>${escapeHtml(r.race)}</td>
          <td class="nowrap">${r.poids ?? ''}</td>
          <td>${escapeHtml(r.age_label)}</td>
          <td>${escapeHtml(r.sterilisee)}</td>
          <td class="nowrap col-date">${escapeHtml(r.date_naissance)}</td>
        </tr>
      `).join('');
      if (!trs) {
        trs = `<tr><td colspan="7" class="muted" style="text-align:center;padding:16px;">Aucune donn√©e</td></tr>`;
      }

      tableWrap.innerHTML = `
        <table>
          <thead><tr>${ths}</tr></thead>
          <tbody>${trs}</tbody>
        </table>
      `;

      tableWrap.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-key');
          if (sortState.key === key) {
            sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
          } else {
            sortState.key = key; sortState.dir = 'asc';
          }
          currentPage = 1;
          applySort(); renderTable(viewRows);
        });
      });

      updatePager(total);
      const startDisp = total === 0 ? 0 : (startIdx + 1);
      const endDisp = endIdx;
      countEl.textContent = `${startDisp}‚Äì${endDisp} sur ${total} √©l√©ment${total>1?'s':''}`;
    }

    function applySort(){
      const { key, dir } = sortState;
      const collator = new Intl.Collator('fr', { sensitivity:'base', numeric:true });
      viewRows.sort((a,b) => {
        if (key === 'poids') {
          const av = a.poids ?? -Infinity;
          const bv = b.poids ?? -Infinity;
          return dir === 'asc' ? (av - bv) : (bv - av);
        }
        if (key === 'age') {
          const av = (a.age_months ?? -Infinity);
          const bv = (b.age_months ?? -Infinity);
          return dir === 'asc' ? (av - bv) : (bv - av);
        }
        const r = collator.compare(String(a[key] ?? ''), String(b[key] ?? ''));
        return dir === 'asc' ? r : -r;
      });
    }

    function applyFilters(){
      const qGlob = globalSearch.value.trim().toLowerCase();
      viewRows = rawRows.filter(r => {
        if (!qGlob) return true;
        const s = `${r.nom} ${r.espece} ${r.race} ${r.sterilisee} ${r.date_naissance} ${r.age_label} ${r.poids ?? ''}`.toLowerCase();
        return s.includes(qGlob);
      });
      currentPage = 1;
      applySort();
      renderTable(viewRows);
    }

    function parseResultParam(str) {
      if (str == null) return [];
      if (Array.isArray(str)) return str;
      if (typeof str !== 'string') return extractArrayFromAny(str);
      try { 
        const v = JSON.parse(str);
        return Array.isArray(v) ? v : extractArrayFromAny(v);
      } catch(_) {}
      const start = str.indexOf('[');
      const end = str.lastIndexOf(']');
      if (start !== -1 && end !== -1 && end > start) {
        const slice = str.slice(start, end + 1);
        try {
          const v = JSON.parse(slice);
          return Array.isArray(v) ? v : extractArrayFromAny(v);
        } catch(_) {}
      }
      return [];
    }

    async function processQuery() {
      const query = q.value.trim();
      messagesEl.innerHTML = '';
      tableWrap.innerHTML = '';
      debugEl.textContent = '';
      if (!query) return showError('Merci de saisir une requ√™te.');

      try {
        setLoading(true);
        const resp = await fetch('/api/filemaker', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });
        const rawText = await resp.text();

        let payload;
        try { payload = JSON.parse(rawText); } catch { payload = { raw: rawText }; }

        showDebugRaw(rawText, payload);

        let fastRows = [];
        if (payload && payload.scriptResult && (payload.scriptResult.resultParameter || payload.scriptResult.ResultParameter)) {
          const rp = payload.scriptResult.resultParameter ?? payload.scriptResult.ResultParameter;
          fastRows = parseResultParam(rp);
        }

        if (!resp.ok) {
          showError(`Erreur ${resp.status} : ${rawText.slice(0, 300)}‚Ä¶`);
          return;
        }

        let arr = [];
        if (Array.isArray(fastRows) && fastRows.length) {
          arr = fastRows;
        } else {
          arr = extractArrayFromAny(payload);
        }
        rawRows = Array.isArray(arr) ? arr.map(normalizeRow) : [];
        viewRows = [...rawRows];

        if (!viewRows.length) {
          showMsg('R√©ponse re√ßue mais aucune ligne pars√©e. V√©rifie le sch√©ma (resultParameter / OData value).', 'err');
          applySort();
          renderTable(viewRows);
          return;
        }

        showMsg(`R√©ponse re√ßue ‚úîÔ∏é (${viewRows.length} lignes)`, 'ok');
        currentPage = 1;
        applySort();
        renderTable(viewRows);
      } catch (err) {
        showError(`Erreur r√©seau : ${err.message}`);
      } finally {
        setLoading(false);
      }
    }
  </script>
</body>
</html>