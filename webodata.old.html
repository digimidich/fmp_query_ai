<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileMaker Script API Query Builder with AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .debug-console {
            background: #000;
            border: 2px solid #0f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
            font-family: 'Courier New', monospace;
        }

        .debug-console h3 {
            color: #0f0;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        #consoleOutput {
            background: #111;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            color: #0f0;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .console-entry {
            margin-bottom: 5px;
            word-wrap: break-word;
        }

        .console-error {
            color: #ff4444;
        }

        .console-success {
            color: #44ff44;
        }

        .console-info {
            color: #4444ff;
        }

        .console-warn {
            color: #ffaa00;
        }

        .config-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .config-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .query-section {
            margin-bottom: 25px;
        }

        .query-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .query-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1.1rem;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .info-box h4 {
            color: #495057;
            margin-bottom: 10px;
        }

        .info-box code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .code-block {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #c3e6cb;
        }

        .debug-box {
            background: #2d2d2d;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            overflow-x: auto;
            border: 1px solid #00ff00;
        }

        .debug-box h5 {
            color: #00ff00;
            margin-bottom: 10px;
        }

        .debug-box pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .data-table {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ FileMaker Script API Query Builder</h1>
            <p>Use natural language to search FileMaker via Script API</p>
        </div>

        <div class="main-card">
            <!-- Debug Console -->
            <div class="debug-console">
                <h3>üñ•Ô∏è Debug Console</h3>
                <div id="consoleOutput">
                    <div class="console-entry console-info">Console initialized. Ready for debugging...</div>
                </div>
                <button class="btn btn-secondary" onclick="clearConsole()">Clear Console</button>
            </div>

            <!-- Configuration Section -->
            <div class="config-section">
                <h3>‚öôÔ∏è OpenAI Configuration</h3>
                <div class="config-grid">
                    <div class="form-group">
                        <label for="openaiKey">OpenAI API Key</label>
                        <input type="password" id="openaiKey" placeholder="sk-..." />
                    </div>
                    <div class="form-group">
                        <label for="openaiModel">AI Model</label>
                        <select id="openaiModel">
                            <option value="gpt-4o-mini">GPT-4o Mini (Fast & Cheap)</option>
                            <option value="gpt-4o">GPT-4o (Better)</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- FileMaker Configuration -->
            <div class="config-section">
                <h3>üóÑÔ∏è FileMaker Script Configuration</h3>
                <div class="config-grid">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="fmScriptUrl">Script URL</label>
                        <input type="text" id="fmScriptUrl" 
                               value="https://digimidi.fmcloud.fm/fmi/odata/v4/DIGIMIDI_DEV/Script.search_pet_n8n" 
                               placeholder="https://server/fmi/odata/v4/database/Script.scriptname" />
                    </div>
                    <div class="form-group">
                        <label for="fmUsername">Username</label>
                        <input type="text" id="fmUsername" placeholder="Username" />
                    </div>
                    <div class="form-group">
                        <label for="fmPassword">Password</label>
                        <input type="password" id="fmPassword" placeholder="Password" />
                    </div>
                    <div class="form-group">
                        <label for="fmAuthBasic">Or Base64 Auth String (optional)</label>
                        <input type="text" id="fmAuthBasic" placeholder="YW50b2luZToxMjMh" />
                    </div>
                </div>
            </div>

            <!-- Info Box -->
            <div class="info-box">
                <h4>üìã How This Works</h4>
                <ul style="list-style: none; padding-left: 10px;">
                    <li style="padding: 5px 0;">1. OpenAI extracts keywords from your natural language query</li>
                    <li style="padding: 5px 0;">2. Keywords are sent to FileMaker Script via <code>scriptParameterValue</code></li>
                    <li style="padding: 5px 0;">3. FileMaker script returns search results as JSON</li>
                    <li style="padding: 5px 0;">4. Results are parsed with jq expression: <code>.scriptResult.resultParameter | split("\\r")[0] | fromjson</code></li>
                </ul>
            </div>

            <!-- Query Section -->
            <div class="query-section">
                <h3>üîç Natural Language Query</h3>
                <div class="query-input-wrapper">
                    <input 
                        type="text" 
                        id="queryInput" 
                        class="query-input" 
                        placeholder="e.g., find all cats, show dogs from last week, list patients named Max..."
                    />
                    <button class="btn btn-primary" onclick="processQuery()">
                        Search FileMaker
                    </button>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Processing your query...</p>
            </div>

            <!-- Results Section -->
            <div id="results" class="results-section"></div>
        </div>
    </div>

    <script>
        // Debug console functions
        function logToConsole(message, type = 'info') {
            const consoleDiv = document.getElementById('consoleOutput');
            const entry = document.createElement('div');
            entry.className = `console-entry console-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            consoleDiv.appendChild(entry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function clearConsole() {
            const consoleDiv = document.getElementById('consoleOutput');
            consoleDiv.innerHTML = '<div class="console-entry console-info">Console cleared.</div>';
        }

        // Override console methods
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
            ).join(' ');
            logToConsole(message, 'success');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
            ).join(' ');
            logToConsole(message, 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
            ).join(' ');
            logToConsole(message, 'warn');
        };

        // Main query processing - matching server.py workflow
        async function processQuery() {
            const query = document.getElementById('queryInput').value;
            const apiKey = document.getElementById('openaiKey').value;
            const model = document.getElementById('openaiModel').value;

            logToConsole('‚á¢ Starting query: ' + query, 'info');

            if (!query) {
                showError('Please enter a query');
                return;
            }

            if (!apiKey) {
                showError('Please enter your OpenAI API key');
                return;
            }

            showLoading(true);
            clearResults();

            try {
                // Step 1: Extract keywords using OpenAI (matching server.py)
                logToConsole('‚á¢ OpenAI keyword extract...', 'info');
                const keywords = await extractKeywords(query, apiKey, model);
                console.log('‚Üê OpenAI JSON ok:', keywords);
                displayDebugInfo('OpenAI Extracted Keywords', keywords);

                // Step 2: Call FileMaker Script with keywords
                const scriptUrl = document.getElementById('fmScriptUrl').value;
                const username = document.getElementById('fmUsername').value;
                const password = document.getElementById('fmPassword').value;
                const authBasic = document.getElementById('fmAuthBasic').value;

                if (!authBasic && (!username || !password)) {
                    showError('Enter username and password, or provide Base64 auth string');
                    return;
                }

                logToConsole('‚Üí FileMaker via script API...', 'info');
                const result = await callFileMakerScript(scriptUrl, keywords, username, password, authBasic);
                
                // Display results
                displayFileMakerResults(result);

            } catch (error) {
                console.error('Error:', error);
                showError(`Error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // Extract keywords exactly like server.py
        async function extractKeywords(query, apiKey, model) {
            const systemPrompt = `You are a keyword extraction specialist. Extract search keywords from natural language and return ONLY a valid JSON object in this format: {"scriptParameterValue": "keyword1 keyword2 keyword3"}. Remove common words like 'the', 'from', 'for', 'all'. Keep names, dates, and specific terms. Never include explanations, only the JSON.`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: query }
                    ],
                    temperature: 0.0,
                    max_tokens: 120
                })
            });

            logToConsole(`OpenAI Response: ${response.status}`, response.ok ? 'success' : 'error');

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`OpenAI API error: ${errorData.error?.message || response.statusText}`);
            }

            const data = await response.json();
            let content = data.choices[0].message.content || "";
            
            // Strip code fences if present (matching server.py logic)
            content = content.trim();
            if (content.startsWith("```")) {
                content = content.replace(/```json\n?/g, '').replace(/```/g, '').trim();
            }

            const parsed = JSON.parse(content);
            if (!parsed.scriptParameterValue) {
                throw new Error("Missing 'scriptParameterValue' in OpenAI response");
            }
            
            return parsed;
        }

        // Call FileMaker Script endpoint (matching server.py curl command)
        async function callFileMakerScript(url, keywords, username, password, authBasic) {
            // Prepare auth header
            let authHeader;
            if (authBasic) {
                authHeader = `Basic ${authBasic}`;
                logToConsole('Using provided Base64 auth', 'info');
            } else {
                authHeader = `Basic ${btoa(username + ':' + password)}`;
                logToConsole('Created Basic auth from credentials', 'info');
            }

            // Prepare the payload EXACTLY like server.py
            const payload = {
                scriptParameterValue: keywords.scriptParameterValue
            };

            console.log('‚Üí FileMaker Script POST:', {
                url: url,
                data: payload
            });

            displayDebugInfo('FileMaker Script Request', {
                url: url,
                method: 'POST',
                payload: payload,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic [REDACTED]'
                }
            });

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    },
                    body: JSON.stringify(payload)
                });

                logToConsole(`FileMaker Response: ${response.status}`, response.ok ? 'success' : 'error');

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('FileMaker error response:', errorText);
                    
                    displayDebugInfo('FileMaker Error', {
                        status: response.status,
                        statusText: response.statusText,
                        response: errorText
                    });

                    if (response.status === 401) {
                        throw new Error('Unauthorized (401): Check username and password');
                    } else if (response.status === 404) {
                        throw new Error('Not Found (404): Check script URL');
                    } else {
                        throw new Error(`FileMaker error ${response.status}: ${errorText}`);
                    }
                }

                const data = await response.json();
                console.log('‚Üê FileMaker raw response:', data);

                // Parse the script result exactly like jq does in server.py
                // jq expression: .scriptResult.resultParameter | split("\\r")[0] | fromjson
                if (!data.scriptResult || !data.scriptResult.resultParameter) {
                    throw new Error('No scriptResult.resultParameter in response');
                }

                let resultParam = data.scriptResult.resultParameter;
                
                // Split by \r and take first part
                if (resultParam.includes('\r')) {
                    resultParam = resultParam.split('\r')[0];
                }

                // Parse as JSON
                const finalResult = JSON.parse(resultParam);
                console.log('‚Üê FileMaker parsed result:', finalResult);
                
                return finalResult;

            } catch (error) {
                if (error.message.includes('Failed to fetch')) {
                    logToConsole('Network/CORS error detected', 'error');
                    displayCurlCommand(url, payload, authHeader);
                    throw new Error('Network error or CORS blocking. Use the cURL command below.');
                }
                throw error;
            }
        }

        function displayFileMakerResults(data) {
            const resultsDiv = document.getElementById('results');
            
            // Success message
            const successBox = document.createElement('div');
            successBox.className = 'success-message';
            successBox.textContent = 'Successfully retrieved data from FileMaker!';
            resultsDiv.appendChild(successBox);

            // Display the parsed JSON result
            const dataBox = document.createElement('div');
            dataBox.className = 'debug-box';
            dataBox.innerHTML = `
                <h5>üìä FileMaker Script Result</h5>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            resultsDiv.appendChild(dataBox);

            // If it's an array of records, show in table format
            if (Array.isArray(data)) {
                displayRecordsTable(data);
            } else if (data.records && Array.isArray(data.records)) {
                displayRecordsTable(data.records);
            } else if (data.data && Array.isArray(data.data)) {
                displayRecordsTable(data.data);
            }
        }

        function displayRecordsTable(records) {
            if (records.length === 0) return;

            const resultsDiv = document.getElementById('results');
            const tableBox = document.createElement('div');
            tableBox.className = 'data-table';
            
            // Get all unique keys
            const keys = [...new Set(records.flatMap(record => Object.keys(record)))];
            
            let tableHtml = '<table><thead><tr>';
            keys.forEach(key => {
                tableHtml += `<th>${escapeHtml(key)}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';
            
            records.forEach(record => {
                tableHtml += '<tr>';
                keys.forEach(key => {
                    const value = record[key];
                    const displayValue = value !== null && value !== undefined ? String(value) : '';
                    tableHtml += `<td>${escapeHtml(displayValue)}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table>';
            tableBox.innerHTML = tableHtml;
            resultsDiv.appendChild(tableBox);
        }

        function displayCurlCommand(url, payload, authHeader) {
            const resultsDiv = document.getElementById('results');
            
            // Build curl command matching server.py format
            const payloadJson = JSON.stringify(payload);
            const curlCommand = `curl -sS -X POST "${url}" \\
  -H "Content-Type: application/json" \\
  -H "Authorization: ${authHeader}" \\
  --data '${payloadJson}' \\
  | jq -r '.scriptResult.resultParameter | split("\\\\r")[0] | fromjson'`;
            
            const curlBox = document.createElement('div');
            curlBox.className = 'result-box';
            curlBox.innerHTML = `
                <h4>cURL Command (matching server.py - use in terminal)</h4>
                <div class="code-block">${escapeHtml(curlCommand)}</div>
                <p style="margin-top: 10px; color: #666;">This is the exact command from server.py. Run it in terminal to test.</p>
            `;
            
            resultsDiv.appendChild(curlBox);

            // Also show without jq for debugging
            const simpleCurl = `curl -sS -X POST "${url}" \\
  -H "Content-Type: application/json" \\
  -H "Authorization: ${authHeader}" \\
  --data '${payloadJson}'`;

            const simpleBox = document.createElement('div');
            simpleBox.className = 'result-box';
            simpleBox.innerHTML = `
                <h4>Simple cURL (without jq parsing)</h4>
                <div class="code-block">${escapeHtml(simpleCurl)}</div>
            `;
            resultsDiv.appendChild(simpleBox);
        }

        function displayDebugInfo(title, data) {
            const resultsDiv = document.getElementById('results');
            
            const debugBox = document.createElement('div');
            debugBox.className = 'debug-box';
            debugBox.innerHTML = `
                <h5>üîç ${title}</h5>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            
            resultsDiv.appendChild(debugBox);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function showError(message) {
            const resultsDiv = document.getElementById('results');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            resultsDiv.appendChild(errorDiv);
            logToConsole('ERROR: ' + message, 'error');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Allow Enter key to submit
        document.getElementById('queryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processQuery();
            }
        });

        // Test console on load
        logToConsole('Page loaded. FileMaker Script API ready!', 'success');
        console.warn('Note: This calls FileMaker Script endpoint, not OData tables directly');
    </script>
</body>
</html>